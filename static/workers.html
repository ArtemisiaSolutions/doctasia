<div class="row-fluid" style="margin-bottom: 20px;">
    <form class="form-horizontal">
        <fieldset class="span12">
            <div class="row-fluid">
                <legend><h3>Add a new worker</h3></legend>
            </div>
            <div id="newWorkerContainer">
            </div>
        </fieldset>
    </form>
</div>

<div class="row-fluid">
    <div class="span12">
        <fieldset class="span12">
            <div class="row-fluid">
                <legend><h3>Workers list</h3></legend>
            </div>
            <div id="workersContainer">
            </div>
        </fieldset>
    </div>
</div>

<script type="text/javascript">

    var workers

    if(!workers) {
        $(window).bind('hashchange', handleWorkersHashChange)
        handleWorkersHashChange()
        workers = true
    }

    function handleWorkersHashChange() {
        var hash = window.location.hash

        if(hash) {

            var hashData = hash.split("/")

            if(hashData.length >= 2 && hashData[1] === 'workers') {

                $("#workersContainer").spinner()

                createAddWorkerForm()
                createWorkersDiv()

            }
        }
    }

    function createAddWorkerForm() {
        var form            = $('<form class="well form-inline"></form>')
        var hostInput       = $('<input type="text" class="input-small" placeholder="Hostname or ip"/>')
        var loginInput      = $('<input type="text" class="input-small" placeholder="user"/>')
        var btn             = $('<button class="btn btn-primary">Add</button>')

        btn.click(function(e) {
            e.preventDefault()
            var worker = {
                host: hostInput.val(),
                user: loginInput.val()
            }

            Facade.addWorker(worker, function(err, res) {
                if(err) {
                    //TODO error
                }

                hostInput.val('')
                loginInput.val('')

                if(!tableBody) {
                    createWorkersDiv()
                } else {
                    var row = createWorkerRow(res)
                    tableBody.append(row)
                }


            })
        })

        form.append(hostInput)
        form.append(loginInput)
        form.append(btn)
        $("#newWorkerContainer").append(form)

    }

    function createWorkerRow(worker) {
        var row = $('<tr></tr>')
        var status = $('<td>' + worker.status + '</td>')

        var actions = $('<td></td>')
        var deleteBtn = $('<button class="btn btn-mini btn-danger">delete</button>')
        var restoreBtn = $('<button class="btn btn-danger">Restore</button>')
        restoreBtn.hide()

        actions.append(restoreBtn)
        actions.append(deleteBtn)


        deleteBtn.click(function() {
            Facade.deleteWorker(worker.host, function(err, result) {
                createWorkersDiv()
            })
        })

        if(worker.status === "Error") {
            restoreBtn.show()
            var errorStatus = $('<a title="' + worker.error + '" rel="tooltip">Error</a>')
            errorStatus.tooltip({
                animation: true
            })
            status.html(errorStatus)
            restoreBtn.click(function(e) {
                e.preventDefault()
                Facade.restoreWorker(worker.host, function(err, res) {
                    if(err) {
                        //TODO error
                    }
                    status.html('Done')
                    restoreBtn.hide()
                })
            })
        }

        row.append('<td>' + worker.host + '</td>')
        row.append(status)
        row.append(actions)

        return row
    }

    function updateRow(tabTd, worker) {
        if($(tabTd[1]).html() !== worker.status) {
            $(tabTd[1]).html(worker.status)
            if(worker.status === "Error") {
                var restoreBtn = $('<button class="btn btn-danger">Restore</button>')
                var errorStatus = $('<a title="' + worker.error + '" rel="tooltip">Error</a>')
                errorStatus.tooltip({
                    animation: true
                })
                $(tabTd[1]).html(errorStatus)
                $(tabTd[2]).append(restoreBtn)
                restoreBtn.click(function(e) {
                    e.preventDefault()
                    Facade.restoreWorker(worker.host, function(err, res) {
                        if(err) {
                            //TODO error
                        }
                        $(tabTd[1]).html('Done')
                        $(tabTd[2]).html('')
                    })
                })
            }
        }
    }

    function updateWorkers() {
        Facade.getWorkers(function(err, workers) {
            if(err) {
                //TODO error
            }

            if(tableBody) {
                var workersRows = $('#workersTableBody tr')

                workers.forEach(function(worker) {

                    var exists = false

                    for(var i = 0; i<workersRows.length; i++) {

                        var tabTd = $(workersRows[i]).children('td')
                        if($(tabTd[0]).html() === worker.host) {
                            exists = true
                            updateRow(tabTd, worker)
                        }

                    }

                    if(!exists) {
                        tableBody.append(createWorkerRow(worker))
                    }

                })
            }


        })
    }

    var tableBody

    function createWorkersDiv() {
        tableBody = undefined
        $('#workersContainer').spinner()

        Facade.getWorkers(function(err, workers) {
            if(err) {
                //TODO error
            }

            if(workers && workers.length > 0) {

                var workersTable = $('<table class="table"></table>')
                var tableHead    = $('<thead><tr><th>Worker Host</th><th>Status</th><th>Actions</th></tr></thead>')
                tableBody        = $('<tbody id="workersTableBody"></tbody>')

                workersTable.append(tableHead)
                workersTable.append(tableBody)

                workers.forEach(function(worker) {
                    var repositoryRow = createWorkerRow(worker)
                    tableBody.append(repositoryRow)
                })

                $('#workersContainer').html(workersTable)
            } else {
                $('#workersContainer').html("There are no workers")
            }

        })

    }


    function Watcher() {

        var time = 2000
        var running = true

        this.stop = function() {
            running = false
        }

        this.run = function() {
            if(running) {
                timer = setTimeout(Checker(this), time)
            }
        }

        function Checker(watcher) {
            return function() {
                if(running) {
                    updateWorkers()
                    watcher.run()
                }
            }
        }

        var timer = setTimeout(Checker(this), 0)
    }

    $(window).bind('hashchange', function() {
        if(watcher) {
            watcher.stop()
            watcher = undefined
        }
    })
    var watcher = new Watcher()

</script>
