<div class="row-fluid">
    <div class="span12">
        <fieldset class="span12">
            <div class="row-fluid">
                <legend><h3>Search</h3></legend>
            </div>
            <div>
                <form class="searchBar" action="javascript: search()">
                    <label for="hubciSearchBar">Search for user: </label>
                    <input type="text" id="hubciSearchBar" name="searchValue" class="search-query" placeholder="Search..." autocomplete="off">
                </form>
            </div>
        </fieldset>
    </div>
</div>

<div class="row-fluid">
    <div class="span12">
        <fieldset class="span12">
            <div class="row-fluid">
                <legend><h3 id="usersLegend"></h3></legend>
            </div>
            <div id="usersContainer">
            </div>
        </fieldset>
    </div>
</div>

<div id="logsPopup" class="modal hide">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">X</button>
        <h3>Logs output</h3>
        <small>You can close this window by pressing the 'esc' key</small>
    </div>
    <div class="modal-body">
        <pre id="logsContainer" class="prettyprint linenums"></pre>
    </div>
</div>
<script type="text/javascript" src="/s/js/ext/google-code-prettify/prettify.js"></script>
<link href="/s/js/ext/google-code-prettify/sons-of-obsidian.css" rel="stylesheet">

<script type="text/javascript">

    var users

    if(!users) {
        $(window).bind('hashchange', handleUsersHashChange)
        handleUsersHashChange()
        users = true
    }


    var lastUser

    function handleUsersHashChange() {
        var hash = window.location.hash

        if(hash) {

            var hashData = hash.split("/")

            if(hashData.length >= 2 && hashData[1] === 'users') {

                $("#usersContainer").spinner()

                if(hashData.length === 2 || hashData[2] === "") {

                    lastUser = undefined
                    renderUsersList()

                } else if(hashData.length === 4 && hashData[2] === "user" && hashData[3] !== lastUser) {

                    lastUser = hashData[3]
                    renderUserPage(hashData[3])
                } else if(hashData.length === 4 && hashData[2] === "search" && hashData[3] !== "") {

                    lastUser = undefined
                    searchForUser(hashData[3])

                } else {

                    lastUser = undefined
                }
            }
        }
    }

    function search() {
        var word = $("#hubciSearchBar").val()
        window.location.href="/#/users/search/"+word
    }

    function createAdminSpan(user) {
        var adminCheckBox = $('<input type="checkbox"/>')
        var adminSpan = $('<span class="pull-right"></span>')
        adminSpan.css('font-size', '14px')
        adminSpan.append("Administrator  ")
        adminSpan.append(adminCheckBox)

        if(user.role === "Admin") {
            adminCheckBox.attr('checked', 'checked')
        }

        adminCheckBox.change(function(e) {
            Facade.setUserAdmin(user.login, adminCheckBox.attr('checked') === 'checked', function(err, result) {
                if(err) {
                    //TODO error
                }
            })
        })

        return adminSpan
    }


    function createSubscriptionDiv(user) {


        var mainDiv = $('<form class="form-horizontal"></form>')

        var divActive = $('<div class="control-group"></div>')
        var divPlan = $('<div class="control-group"></div>')
        var divExpiration = $('<div class="control-group"></div>')

        var controlsActive = $('<div class="controls"></div>')
        var controlsPlan = $('<div class="controls"></div>')
        var controlsExpiration = $('<div class="controls"></div>')

        var labelActive = $('<label class="control-label">Subscription is active: </label>')
        var checkbox = $('<input type="checkbox" value="isActive" id="isActive" name="isActive"/>')

        divActive.append(labelActive)
        controlsActive.append(checkbox)
        divActive.append(controlsActive)

        var labelPlan = $('<label class="control-label">Plan: </label>')
        var planSelect = $('<select name="plan"></select>')
        planSelect.append('<option value="Free">Free</option>')
        planSelect.append('<option value="Trial">Trial</option>')
        planSelect.append('<option value="Medium">Medium</option>')
        planSelect.append('<option value="Large">Large</option>')

        planSelect.append('<option value="Custom">Custom</option>')

        divPlan.append(labelPlan)
        controlsPlan.append(planSelect)
        divPlan.append(controlsPlan)

        var labelDate = $('<label class="control-label">Expiration date: </label>')
        var dateExp = $('<input type="text">')
        dateExp.datepicker({dateFormat: "mm/dd/yy"})

        divExpiration.append(labelDate)
        controlsExpiration.append(dateExp)
        divExpiration.append(controlsExpiration)

        mainDiv.append(divActive)
        mainDiv.append(divPlan)
        mainDiv.append(divExpiration)

        if(user.subscription && user.subscription.isActive) {

            checkbox.attr('checked', 'checked')

            if(user.subscription.expirationDate) {
                var date = new Date(user.subscription.expirationDate)
                var month = date.getMonth()+1
                var defaultDate =  month+'/'+date.getDate()+'/'+date.getFullYear()
                dateExp.val(defaultDate)
            }
            if(user.subscription.plan) {
                planSelect.children("option[value='" + user.subscription.plan + "']").attr('selected','selected')
            }

        } else {
            dateExp.attr('disabled', 'disabled')
            planSelect.attr('disabled', 'disabled')
        }


        function updateSubscription() {

            var splitDate = dateExp.val().split('/')
            var isActive = checkbox.attr('checked') === 'checked'
            var plan = planSelect.children('option:selected').val()
            var date = new Date(splitDate[2], splitDate[0]-1, splitDate[1], 0, 0, 0, 0).toISOString()
            var subscription = {
                isActive: isActive
            }

            if(isActive) {
                subscription.plan = plan
                subscription.expirationDate = date
            }


            Facade.updateSubscription(user.login, subscription, function(err, res) {
                if(err) {
                    //TODO error
                }
            })

        }

        checkbox.change(function(e) {
            updateSubscription()
            if(checkbox.attr('checked') === 'checked') {
                dateExp.removeAttr('disabled')
                planSelect.removeAttr('disabled')
            } else {
                dateExp.attr('disabled', 'disabled')
                planSelect.attr('disabled', 'disabled')
            }
        })

        planSelect.change(function(e) {
            updateSubscription()
        })

        dateExp.change(function(e) {
            updateSubscription()
        })

        return mainDiv
    }

    function createRepositoryRow(repository) {
        var row = $('<tr></tr>')
        var lastRun = "Never run"
        var statusRow = $('<td>N/A</td>')

        if(repository.lastBuild && repository.lastBuild.dateRun) {
            lastRun = new Date(repository.lastBuild.dateRun).toUTCString()
        }

        if(repository.status) {
            var status = $('<a>' + repository.status + '</a>')
            status.click(function(e) {
                $("#logsContainer").spinner()
                $("#logsPopup").modal('show')
                e.preventDefault()
                Facade.getLastBuildJob(repository.owner.login, repository.name, function(err, buildJob) {
                    if(buildJob && buildJob.report && buildJob.report.cmdOut && buildJob.report.cmdOut.logs) {
                        $("#logsContainer").text(buildJob.report.cmdOut.logs)
                    } else {
                        $("#logsContainer").html("No logs are available")
                    }

                    prettyPrint()

                })
            })
            statusRow.html(status)
        }

        row.append('<td>' + repository.owner.login + '</td>')
        row.append('<td>' + repository.name + '</td>')
        row.append('<td>' + lastRun + '</td>')
        row.append(statusRow)

        return row
    }

    function renderUserPage(login) {

        Facade.getUser(login, function(err, user) {

            if(err) {
                //TODO error
            }

            $("#logsPopup").modal({
                backdrop: true,
                keyboard: true,
                show: false
            })

            var adminSpan = createAdminSpan(user)

            $("#usersLegend").html(login)
            $("#usersLegend").append(adminSpan)

            Facade.getRepositoriesForUser(login, function(err, repositories) {
                if(err) {
                    //TODO error
                }

                $('#usersContainer').html('')


                var repositoriesTable   = $('<table class="table"></table>')
                var tableHead           = $('<thead><tr><th>Repository owner</th><th>Repository name</th><th>Last Run</th><th>Status</th></tr></thead>')
                var tableBody           = $('<tbody></tbody>')
                repositories.forEach(function(repository) {
                    var repositoryRow = createRepositoryRow(repository)
                    tableBody.append(repositoryRow)
                })

                //Append the repositories table
                repositoriesTable.append(tableHead)
                repositoriesTable.append(tableBody)
                var tableDiv = $('<div></div>')
                tableDiv.append(repositoriesTable)
                var repositoriesField = createFieldset('<h4>Repositories</h4>', tableDiv)
                $('#usersContainer').append(repositoriesField)

                //And the subscription fieldset
                var subscriptionDiv = createSubscriptionDiv(user)
                var subscriptionField = createFieldset('<h4>Subscription</h4>', subscriptionDiv)
                $('#usersContainer').append(subscriptionField)

            })

        })
    }

    function createFieldset(title, div) {
        var div1 = $('<div class="row-fluid"></div>')
        var div2 = $('<div class="span12"></div>')
        var fieldset = $('<fieldset class="span12"></fieldset>')
        var div3 = $('<div class="row-fluid"></div>')
        var legend = $('<legend>' + title + '</legend>')
        div1.css("margin-bottom", "20px")
        div3.append(legend)
        fieldset.append(div3)
        fieldset.append(div)
        div2.append(fieldset)
        div1.append(div2)

        return div1
    }

    function createOrderedUsersList(users) {

        var globalDiv = $('<div></div>')

        var firstLetter
        var letterDiv

        users.forEach(function(user) {

            if(user.login[0].toUpperCase() !== firstLetter) {

                if(letterDiv) {
                    var fieldset = createFieldset(firstLetter, letterDiv)
                    globalDiv.append(fieldset)
                }
                firstLetter = user.login[0].toUpperCase()
                letterDiv = $('<div></div>')
            }

            letterDiv.append('<div><a href="/#/users/user/' + user.login + '">' + user.login + '</a></div>')

        })

        var fieldset = createFieldset(firstLetter.toUpperCase(), letterDiv)
        globalDiv.append(fieldset)

        return globalDiv
    }

    function renderUsersList() {

        Facade.getUsers(function(err, users) {
            if(err) {
                //TODO error
            }

            $("#usersLegend").html("Users list")

            var usersList = createOrderedUsersList(users)

            $("#usersContainer").html(usersList)
        })
    }

    function searchForUser(login) {
        Facade.searchForUser(login, function(err, result) {
            if(err) {
                //TODO error
            }
            if(result.length === 1) {
                var user = result[0]
                window.location.href = "/#/users/user/"+user.login
            } else if(result.length > 1) {
                var foundUsers = createOrderedUsersList(result)
                $("#usersLegend").html("Results")
                $("#usersContainer").html(foundUsers)
            } else {
                $("#resultsContainer").html("No result found for: "+word)
            }
        })
    }

</script>